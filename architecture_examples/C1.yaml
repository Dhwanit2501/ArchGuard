# Upadted 

# Simple Cloud Web Application Architecture
archguard_version: "1.0.0"

project:
  name: "Simple Web Application"
  id: "aws-web-app"
  cloud_provider: aws

trust_zones:
  - id: internet
    name: "Internet"
    trust_level: untrusted
    description: "External users"

  - id: public-subnets
    name: "Public Subnets (Multi-AZ)"
    trust_level: low
    description: "Internet-facing components"

  - id: private-web-tier
    name: "Private Subnets - Web Tier (Multi-AZ)"
    trust_level: medium
    description: "Application servers"

  - id: private-db-tier
    name: "Private Subnets - Database Tier (Multi-AZ)"
    trust_level: trusted
    description: "Data storage layer"

components:
  # Internet
  - id: users
    name: "Users"
    type: actor
    trust_zone: internet
    internet_facing: true                  # Gap 3
    properties:
      logging: false                        # Gap 5

  # Public Subnets
  - id: igw
    name: "Internet Gateway"
    type: network-gateway
    trust_zone: public-subnets
    internet_facing: true                  # Gap 3
    cloud_service: igw
    properties:
      internet_facing: true
      logging: true                         # Gap 5

  - id: alb
    name: "Application Load Balancer"
    type: load-balancer
    trust_zone: public-subnets
    internet_facing: true                  # Gap 3
    cloud_service: elb
    properties:
      type: application
      multi_az: true
      health_checks: true
      logging: true                         # Gap 5

  # Private Web Tier
  - id: web-server-1
    name: "Web Server 1"
    type: compute
    trust_zone: private-web-tier
    internet_facing: false                 # Gap 3
    cloud_service: ec2
    properties:
      availability_zone: az-1
      instance_type: ec2
      logging: true                         # Gap 5

  - id: web-server-2
    name: "Web Server 2"
    type: compute
    trust_zone: private-web-tier
    internet_facing: false                 # Gap 3
    cloud_service: ec2
    properties:
      availability_zone: az-2
      instance_type: ec2
      logging: true                         # Gap 5

  - id: iam-role
    name: "EC2 IAM Role"
    type: iam-identity
    trust_zone: private-web-tier
    internet_facing: false                 # Gap 3
    cloud_service: iam
    properties:
      attached_to: [web-server-1, web-server-2]
      permissions: []
      logging: true                         # Gap 5: IAM actions should always be logged

  # Private Database Tier
  - id: mysql-db
    name: "MySQL Database"
    type: database
    trust_zone: private-db-tier
    internet_facing: false                 # Gap 3
    cloud_service: rds
    technologies: [mysql]
    properties:
      multi_az: true
      encrypted_at_rest: true              # Gap 4: consistent field name
      public_access: false
      logging: true                         # Gap 5

assets:
  - id: user-requests
    name: "User Requests"
    sensitivity: low

  - id: application-data
    name: "Application Data"
    sensitivity: high

  - id: database-credentials
    name: "Database Credentials"
    sensitivity: critical

  - id: iam-credentials
    name: "IAM Role Credentials"
    sensitivity: critical

data_flows:
  # Users to Internet Gateway
  - id: df1
    name: "User Request"
    source: users
    destination: igw
    protocol: https
    crosses_boundary: true
    encrypted_in_transit: true             # Gap 1
    authenticated: false                   # Gap 2: unauthenticated public traffic
    assets: [user-requests]

  # Internet Gateway to ALB
  - id: df2
    name: "IGW to ALB"
    source: igw
    destination: alb
    protocol: https
    crosses_boundary: false
    encrypted_in_transit: true             # Gap 1
    authenticated: false                   # Gap 2
    assets: [user-requests]

  # ALB to Web Servers
  - id: df3
    name: "ALB to Web Server 1"
    source: alb
    destination: web-server-1
    protocol: http
    crosses_boundary: true
    encrypted_in_transit: false            # Gap 1: HTTP internally, not HTTPS
    authenticated: false                   # Gap 2
    properties:
      load_balanced: true

  - id: df4
    name: "ALB to Web Server 2"
    source: alb
    destination: web-server-2
    protocol: http
    crosses_boundary: true
    encrypted_in_transit: false            # Gap 1
    authenticated: false                   # Gap 2
    properties:
      load_balanced: true

  # Web Servers to IAM Role
  - id: df5
    name: "Web Server 1 uses IAM"
    source: web-server-1
    destination: iam-role
    protocol: aws-internal
    crosses_boundary: false
    encrypted_in_transit: true             # Gap 1: AWS internal always encrypted
    authenticated: true                    # Gap 2: IAM role assumption is authenticated
    flow_type: assumes-role
    assets: [iam-credentials]

  - id: df6
    name: "Web Server 2 uses IAM"
    source: web-server-2
    destination: iam-role
    protocol: aws-internal
    crosses_boundary: false
    encrypted_in_transit: true             # Gap 1
    authenticated: true                    # Gap 2
    flow_type: assumes-role
    assets: [iam-credentials]

  # Web Servers to Database
  - id: df7
    name: "Web Server 1 to MySQL"
    source: web-server-1
    destination: mysql-db
    protocol: mysql
    port: 3306
    crosses_boundary: true
    encrypted_in_transit: false            # Gap 1: MySQL not encrypted in transit by default
    authenticated: true                    # Gap 2
    assets: [application-data, database-credentials]

  - id: df8
    name: "Web Server 2 to MySQL"
    source: web-server-2
    destination: mysql-db
    protocol: mysql
    port: 3306
    crosses_boundary: true
    encrypted_in_transit: false            # Gap 1
    authenticated: true                    # Gap 2
    assets: [application-data, database-credentials]